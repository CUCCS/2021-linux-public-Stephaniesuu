

# 无人值守安装镜像实验报告

## 一、实验环境

* Virtualbox
* Ubuntu 20.04 Server 64bit
* Windows 10

## 二、实验目的

- 配置无人值守安装iso并在Virtualbox中完成自动化安装。
- Virtualbox安装完Ubuntu之后新添加的网卡实现系统开机自动启用和自动获取IP。
- 使用sftp在虚拟机和宿主机之间传输文件。



## 三、实验过程

### 一、到ubuntu官网下载

到https://ubuntu.com/download/server中下载好server版本.

![ubuntu-download](img/ubuntu-download.png)

### 二、ubuntu有人值守安装过程

1. 打开virtualbox点击新建虚拟电脑。

2. 输入名称。
![CreateNewVirtrualMachine_name](img/CreateNewVirtrualMachine_name.png)

3. 单击下一步，设置分配给虚拟电脑的内存。
![CreateNewVirtrualMachine_storagesize](img/CreateNewVirtrualMachine_storagesize.png)

4. 选择现在创建虚拟硬盘。
![CreateNewVirtrualMachine_hardDisk1](img/CreateNewVirtrualMachine_hardDisk1.png)

5. 文件类型默认。
![CreateNewVirtrualMachine_hardDisk2](img/CreateNewVirtrualMachine_hardDisk2.png)

![CreateNewVirtualMachine_DynamicAllocation](img/CreateNewVirtualMachine_DynamicAllocation.png)



6. 自主设定虚拟硬盘的大小，由于在上一步中选择了动态分配，这里可以将虚拟硬盘的大小设置得大一些。
![CreateNewVirtualMachine_DocumentSize](img/CreateNewVirtualMachine_DocumentSize.png)

7. 单击设置-存储，在右侧分配光驱中选择载入之前下载好的镜像iso文件。
![Add_IDE](img/Add_IDE.png)

8. 设置双网卡。
![Add_DualNetworkCard](img/Add_DualNetworkCard.png)

9. 返回的主界面，确认你的镜像文件，下面就可以点击启动了。
![Ensure_IDE](img/Ensure_IDE.png)

![ubuntu_install](img/ubuntu_install.png)

10. 一路按enter键来到设置用户名/密码界面。
![ubuntu_install_name](img/ubuntu_install_name.png)

11. 选择install openssh server
![ubuntu_install_ssh](img/ubuntu_install_ssh.png)

### 三、制作无人值守安装镜像

1. 在虚拟机中查询该虚拟机两个网卡ip地址：

```
ip a
```

![find_ip](img/find_ip.png)

ubuntu系统

用户名：stephaniesu-cuc

NAT：10.0.2.15

Host-Only：192.168.56.102

在主机中，打开cmd命令行，通过ssh连接Linux：

```
ssh stephaniesu-cuc@192.168.56.102
```

![cmd_netLinux](img/cmd_netLinux.png)

在已连接到linux的主机上输入命令，使server端创建新目录clone，在新目录下创建新文件meta-data

```
 mkdir clone

  cat << EOF > ~/clone/meta-data
  instance-id: 1
  local-hostname:stephaniesu
  EOF
```

创建clone目录和文件成功：
![Create_Document](img/Create_Document.png)

退出ssh远程连接，在window的cmd界面下获取手动安装Ubuntu后得到的初始自动配置描述文件。

```
sudo scp stephaniesu-cuc@192.168.56.102:/var/log/installer/autoinstall-user-data d:/
```

![Download_userdata](img/Download_userdata.png)

![Download_userdataSuccessful](img/Download_userdataSuccessful.png)

通过mergely在线手动编辑手动编辑 user-data 配置文件：
![Edit_userdata](img/Edit_userdata.png)

```
#cloud-config
autoinstall:
  apt:
    geoip: true
    preserve_sources_list: false
    primary:
    - arches: [amd64, i386]
      uri: http://cn.archive.ubuntu.com/ubuntu
    - arches: [default]
      uri: http://ports.ubuntu.com/ubuntu-ports
  identity: {hostname: stephaniesu, password: $6$QpB.4/JvpVmjyPci$DVYCJ.kQnQU96eS3of6MxOBuHgkKfmBTd.nrScshI7eiWk6hxKhqAI8QWSkS8OVK6CY.Cz7ekFulDe0ZA5R531,
    realname: Stephaniesu, username: stephaniesu-cuc}
  keyboard: {layout: us, toggle: null, variant: ''}
  timezone: Asia/Shanghai
  locale: en_US.UTF-8
  network:
    ethernets:
      enp0s3: {dhcp4: true}
      enp0s8: {dhcp4: true}
    version: 2
  ssh:
    allow-pw: true
    authorized-keys: []
    install-server: true
  storage:
    config:
    - {ptable: gpt, path: /dev/sda, wipe: superblock,
      preserve: false, name: '', grub_device: true, type: disk, id: disk-sda}
    - {device: disk-sda, size: 1MB, flag: bios_grub, number: 1, preserve: false,
      grub_device: false, type: partition, id: partition-0}
    - {device: disk-sda, size: 1GB, wipe: superblock, flag: '', number: 2,
      preserve: false, grub_device: false, type: partition, id: partition-1}
    - {fstype: ext4, volume: partition-1, preserve: false, type: format, id: format-0}
    - {device: disk-sda, size: -1, wipe: superblock, flag: '', number: 3,
      preserve: false, grub_device: false, type: partition, id: partition-2}
    - name: ubuntu-vg
      devices: [partition-2]
      preserve: false
      type: lvm_volgroup
      id: lvm_volgroup-0
    - {name: ubuntu-lv, volgroup: lvm_volgroup-0, size: -1, preserve: false,
      type: lvm_partition, id: lvm_partition-0}
    - {fstype: ext4, volume: lvm_partition-0, preserve: false, type: format, id: format-1}
    - {device: format-1, path: /, type: mount, id: mount-1}
    - {device: format-0, path: /boot, type: mount, id: mount-0}
  version: 1

```

将修改后的autoinstall-user-data文件更名为user-data，在window的cmd界面下，将文件传回linux。并查看是否传输成功。

```
scp d:/user-data stephaniesu-cuc@192.168.56.102:~/clone
```

![upload_userdata](img/upload_userdata.png)

将user-data,meta-data制作成iso文件。

```
sudo apt install genisoimage #安装genisoimage
genisoimage -input-charset utf-8 -output init.iso -volid cidata -joliet -rock user-data meta-data #创造镜像文件
```

![make_iso](img/make_iso.png)

将制作好的镜像文件init.iso传输回windows客户端。

![Download_iso](img/Download_iso.png)

![Download_isoSuccessful](img/Download_isoSuccessful.png)



### 四、配置ubuntu无人值守安装

新建一个虚拟机，移除虚拟机「设置」-「存储」-「控制器：IDE」，并在「控制器：SATA」下新建2个虚拟光盘，按顺序先挂载「纯净版Ubuntu安装镜像文件」后挂载init.iso
![autoinstall_settingStorage](img/autoinstall_settingStorage.png)



启动虚拟机，稍等一会后，看到是否继续进行无人值守安装的提示，填写yes。
![autoinstall_continue](img/autoinstall_continue.png)

安装完成：
![autoinstall_successful](img/autoinstall_successful.png)



### 五、Virtualbox安装完Ubuntu之后新添加的网卡实现系统开机自动启用和自动获取IP。

1. 在虚拟机设置中添加host-only网卡。
   ![set_Hostonly](img/set_Hostonly.png)

   

2. 打开虚拟机，通过命令`ifconfig`可以看到工作的网卡。

   ![Query_networkCard](img/Query_networkCard.png)

   发现新添加的网卡没有自动启用也没有自动获取ip。

3. 使用vim打开文件

   ```
   sudo vim /etc/netplan/00-installer-config.yaml
   ```

   ![set_netCardConfig](img/set_netCardConfig.png)

   英文状态下按下`i`键进入“插入模式”，插入

   ```
   enp0s9:
     dhcp4:true
   ```

   ![set_netCardConfig2](img/set_netCardConfig2.png)

   然后按`esc`键退出“插入模式”，回到“命令模式”，在“命令模式”下，输入英文状态的`:`进入“底行模式”，输入`wq`保存并退出。

4. 最后执行`sudo netplan apply`生效。

5. 重启虚拟机，输入命令`ifconfig`，发现工作的网卡发现新添加的网卡能实现系统开机自动启用和自动获取IP。![autoNetCard](img/autoNetCard.png)

   



## 四、实验问题以及解决方法

1. 使用sftp传输文件时一直不成功，找不到传输好的文件。以为是保存文件路径输入出错的问题，结果发现之前的操作都是已经ssh连接和进行的。需注意应在客户端输入在服务端下载文件的代码。而不是通过ssh连接到服务端后再从服务端下载，即出现自己连接到自己本地服务器并从本地下载到本地的乌龙。
2. 手动编辑user-data文件的时候，编辑缺漏，导致挂载镜像后无法实现无人值守安装。重新检查了一遍文件，进行更改。
3. 提交作业时，使用相对路径导入图片，把"/"写成了"\"，导致图片显示错误。通过查看语雀里哥姐的提问，已更改解决。
4. 关于github的branch还是不熟练。



## 五、参考资料

* [老师的课件](https://github.com/c4pr1c3/LinuxSysAdmin/blob/a3c3ed18cf38b9e4be1ea53b46efe7f02e4ab8b5/chap0x01.exp.md)
* [语雀](https://www.yuque.com/c4pr1c3/linux)
* [linux command](https://www.runoob.com/linux/linux-comm-ls.html)
* [Ubuntu 开启SSH服务实现远程登录与文件传输](https://blog.csdn.net/ACK_ACK/article/details/102481136?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_utm_term-1&spm=1001.2101.3001.4242)
* [关于通过scp保存文件路径出错的问题](https://blog.csdn.net/wuliuqi_567/article/details/103633519)
* [ubuntu添加新网卡后设置自动启用并获取ip](https://blog.csdn.net/xiongyangg/article/details/110206220)

